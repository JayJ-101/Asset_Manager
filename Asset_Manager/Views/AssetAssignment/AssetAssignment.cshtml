@model AssignmentViewModel

@{
    var action = ViewContext.RouteData.Values["action"]!.ToString()!.Capitalize();
    ViewData["Title"] = $"{action} Asset";
}

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6 col-xl-5"> 
            <div class="card shadow-sm">
          
                <div class="card-body">
                    <form asp-action="@action" method="post" class="needs-validation" novalidate>
                        <input type="hidden" asp-for="AssetAssignment.AssingmentId" />
                        <input type="hidden" name="Operation" value="@action" />

                        @if (action.EqualsNoCase("delete"))
                        {
                            <div class="alert alert-warning">
                                <h5 class="alert-heading">Confirm Deletion</h5>
                                <p class="mb-0">Are you sure you want to delete this assignment?</p>
                            </div>
                            
                            <div class="row">
                                <div class="col-12">
                                    <dl class="row">
                                        <dt class="col-sm-4">Asset:</dt>
                                        <dd class="col-sm-8">@Model.AssetAssignment.Asset?.AssetName</dd>
                                        
                                        <dt class="col-sm-4">Assigned To:</dt>
                                        <dd class="col-sm-8">@Model.AssetAssignment.Employee</dd>
                                        
                                        <dt class="col-sm-4">Branch:</dt>
                                        <dd class="col-sm-8">@Model.AssetAssignment.Branch?.BranchName</dd>
                                        
                                        <dt class="col-sm-4">Assigned Date:</dt>
                                        <dd class="col-sm-8">@Model.AssetAssignment.AssginedDate??.ToString("MMM dd, yyyy")</dd>
                                    </dl>
                                </div>
                            </div>
                        }
                        else
                        {
                            <!-- Asset Selection -->
                            <div class="row mb-3">
                                <label class="col-form-label col-md-4">Asset:</label>
                                <div class="col-md-8">
                                    @if (Model.AssetAssignment.AssetId != 0)
                                    {
                                        var selectedAsset = Model.Assets.FirstOrDefault(a => a.AssetId == Model.AssetAssignment.AssetId);
                                        <div class="input-group">
                                            <input type="text" class="form-control" value="@selectedAsset?.AssetName" readonly />
                                            <span class="input-group-text"><i class="fas fa-laptop"></i></span>
                                        </div>
                                        <input type="hidden" asp-for="AssetAssignment.AssetId" />
                                    }
                                    else
                                    {
                                        <select asp-for="AssetAssignment.AssetId" class="form-select" required>
                                            <option value="">-- Select Asset --</option>
                                            @foreach (var asset in Model.Assets)
                                            {
                                                <option value="@asset.AssetId">@asset.AssetName</option>
                                            }
                                        </select>
                                        <div class="invalid-feedback">Please select an asset.</div>
                                    }
                                </div>
                            </div>

                            <!-- Branch Selection -->
                            <div class="row mb-3">
                                <label class="col-form-label col-md-4">Branch:</label>
                                <div class="col-md-8">
                                    <select asp-for="AssetAssignment.BranchId" class="form-select" required>
                                        <option value="">-- Select Branch --</option>
                                        @foreach (var branch in Model.Branches)
                                        {
                                            <option value="@branch.BranchId">@branch.BranchName</option>
                                        }
                                    </select>
                                    <div class="invalid-feedback">Please select a branch.</div>
                                </div>
                            </div>

                            <!-- Department Selection -->
                            <div class="row mb-3">
                                <label class="col-form-label col-md-4">Department:</label>
                                <div class="col-md-8">
                                    <select asp-for="AssetAssignment.DepartmentId" class="form-select" required>
                                        <option value="">-- Select Department --</option>
                                        @foreach (var dept in Model.Departments)
                                        {
                                            <option value="@dept.DepartmentId">@dept.DepartmentName</option>
                                        }
                                    </select>
                                    <div class="invalid-feedback">Please select a department.</div>
                                </div>
                            </div>

                            <!-- Employee Name -->
                            <div class="row mb-3">
                                <label asp-for="AssetAssignment.Employee" class="col-form-label col-md-4">Employee:</label>
                                <div class="col-md-8">
                                    <input type="text" asp-for="AssetAssignment.Employee" class="form-control" 
                                           placeholder="Enter employee name" required maxlength="100" />
                                    <div class="invalid-feedback">Please enter employee name.</div>
                                </div>
                            </div>

                            <!-- Date Fields -->
                            <div class="row mb-3">
                                <label asp-for="AssetAssignment.AssginedDate" class="col-form-label col-md-4">Assigned Date:</label>
                                <div class="col-md-8">
                                    <input type="date" asp-for="AssetAssignment.AssginedDate" class="form-control" required />
                                    <div class="invalid-feedback">Please select assignment date.</div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <label asp-for="AssetAssignment.ReturnDate" class="col-form-label col-md-4">Return Date:</label>
                                <div class="col-md-8">
                                    <input type="date" asp-for="AssetAssignment.ReturnDate" class="form-control" />
                                    <small class="form-text text-muted">Leave empty if not returned yet.</small>
                                </div>
                            </div>
                        }

                        <!-- Action Buttons -->
                        <div class="row">
                            <div class="@(action.EqualsNoCase("delete") ? "mt-2" : "offset-md-2")">
                                <button type="submit" class="btn btn-primary">@action</button>
                                <a asp-action="Index" class="btn btn-secondary">Cancel</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    
    <script>
        // Enhanced client-side validation
        (function () {
            'use strict';
            window.addEventListener('load', function () {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function (form) {
                    form.addEventListener('submit', function (event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();

        // Date validation
        document.addEventListener('DOMContentLoaded', function () {
            const assignedDate = document.getElementById('AssetAssignment_AssginedDate');
            const returnDate = document.getElementById('AssetAssignment_ReturnDate');

            if (assignedDate && returnDate) {
                returnDate.addEventListener('change', function () {
                    if (assignedDate.value && returnDate.value) {
                        if (new Date(returnDate.value) < new Date(assignedDate.value)) {
                            returnDate.setCustomValidity('Return date cannot be before assigned date');
                        } else {
                            returnDate.setCustomValidity('');
                        }
                    }
                });
            }
        });
    </script>
}